<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QPUC Picker - Google Sheets Sync</title>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --blue-main: #3498db;
            --white: #ffffff;
            --yellow-4als: #f1c40f;
            --orange-faf: #e67e22;
            --red-win: #c0392b;
            --btn-border: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--bg-dark); color: var(--white);
            font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden;
        }

        .main-container {
            width: 100%; max-width: 400px; 
            height: 100vh; 
            margin: 0 auto;
            display: flex; flex-direction: column; align-items: center;
            /* Ajout d'un padding en bas pour éviter la zone de navigation du téléphone */
            padding: 15px 15px calc(30px + env(safe-area-inset-bottom)) 15px; 
            box-sizing: border-box; 
            justify-content: space-between;
        }

        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-top-reset {
            background: none; border: 1.5px solid var(--btn-border);
            color: white; border-radius: 30px; padding: 6px 15px;
            font-size: 0.75rem; cursor: pointer; text-transform: uppercase; font-weight: 600;
        }

        .btn-prochaine-partie {
            background-color: var(--blue-main); color: white;
            width: 100%; border-radius: 50px; padding: 15px 0;
            font-size: 1.4rem; border: none; cursor: pointer;
            text-transform: uppercase; margin-top: 5px; font-weight: 700;
        }

        #current-players { 
            display: flex; flex-direction: column; align-items: center; 
            gap: 12px; margin-top: 5px; flex: 1; width: 100%; justify-content: center; 
        }

        .player-row { display: flex; gap: 8px; justify-content: center; width: 100%; }

        .player-badge {
            background: white; color: black; border-radius: 25px;
            padding: 10px 15px; font-size: 1rem; min-width: 85px;
            text-align: center; cursor: pointer; font-weight: 700; text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .nav-buttons { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            margin-bottom: 10px; /* Espace supplémentaire sous les boutons */
        }

        .btn-nav { 
            background: none; border: 1.5px solid var(--btn-border); 
            color: white; border-radius: 30px; padding: 12px 0; 
            font-size: 0.85rem; cursor: pointer; text-transform: uppercase; 
            width: 100%; font-weight: 600; 
        }

        /* --- Styles Modales --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 1000; padding: 10px; box-sizing: border-box; }
        .modal { background: white; border-radius: 25px; width: 95%; max-width: 380px; margin: 20px auto; position: relative; padding: 15px; color: black; display: flex; flex-direction: column; max-height: 85vh; }
        .close-btn { position: absolute; top: -10px; right: -5px; width: 35px; height: 35px; background: #d00; border-radius: 50%; color: white; border: 2px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; }
        .stats-table { width: 100%; border-collapse: collapse; }
        .stats-table td, .stats-table th { padding: 8px 4px; text-align: center; font-size: 0.85rem; border-bottom: 1px solid #eee; }
        .scroll-content { flex: 1; overflow-y: auto; padding-right: 5px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="top-bar">
            <button class="btn-top-reset" onclick="window.resetSession()">Nouvelle séance</button>
            <span id="sync-status" style="font-size: 0.6rem; opacity: 0.5;">Sheet connecté</span>
        </div>
        
        <button class="btn-prochaine-partie" id="btn-tirage" onclick="window.tirage()">Prochaine Partie</button>
        
        <div id="current-players"></div>

        <div class="nav-buttons">
            <button class="btn-nav" onclick="window.openM('modal-p')">Participants</button>
            <button class="btn-nav" onclick="window.openM('modal-sj')">Parties aujourd'hui</button>
            <button class="btn-nav" onclick="window.openM('modal-sp')">Statistiques (Sheet)</button>
        </div>
    </div>

    <div id="modal-p" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-p')">✕</div>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input type="text" id="add-input" placeholder="Nom..." style="flex:1; padding:8px; border-radius:10px; border:1px solid #ccc;">
                <button onclick="window.addPlayer()" style="background:var(--blue-main); color:white; border:none; width:35px; border-radius:50%;">+</button>
            </div>
            <div class="scroll-content"><div id="list-p" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;"></div></div>
        </div>
    </div>

    <div id="modal-sp" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-sp')">✕</div>
            <h3 style="text-align:center; margin-top:0;">Global (Sheet)</h3>
            <div class="scroll-content">
                <table class="stats-table">
                    <thead><tr><th>NOM</th><th>PJ</th><th>4A</th><th>FAF</th><th>W</th></tr></thead>
                    <tbody id="list-stats-sheet"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-sj" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-sj')">✕</div>
            <h3 style="text-align:center; margin-top:0;">Session en cours</h3>
            <div class="scroll-content">
                <table class="stats-table">
                    <thead><tr><th>NOM</th><th>PARTIES</th></tr></thead>
                    <tbody id="list-stats-jour"></tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    // ... Garde toute la logique Script (Firebase/Sheet) de la version précédente ...
    // N'oublie pas de mettre ta WEB_APP_URL
    const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQPwvi8vHPm7xDs4Yusv0xmZq7ek9Z2ZQJ8DvcWITvkoiwanW5pGwwqJzESzeBNW0LEa_WibdeA3b0Z/pub?output=csv`;
    const WEB_APP_URL = `https://script.google.com/macros/s/AKfycbxB38LwC9z7HkZlVDx_cSi5GBS-H0ExxaCfKPRWkzekl_exh6Lf1_xev-ymwqUH1o1f/exec`;

    window.players = [];
    window.poolEnJeu = [];
    window.playerStates = {};
    window.sessionStats = {};

    async function loadData() {
        try {
            const res = await fetch(CSV_URL);
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            window.players = rows.map(r => {
                const cols = r.split(',');
                return { name: cols[0].trim(), active: true };
            }).filter(p => p.name !== "");
            window.updateUI();
        } catch(e) { console.error("Erreur Sheet", e); }
    }

    window.tirage = async () => {
        if(window.poolEnJeu.length === 5) {
            const results = window.poolEnJeu.map(n => ({
                name: n,
                status: window.playerStates[n] || 0
            }));
            // Envoi au Sheet (Optionnel selon ton avancée Apps Script)
            if(WEB_APP_URL !== `https://script.google.com/macros/s/AKfycbxB38LwC9z7HkZlVDx_cSi5GBS-H0ExxaCfKPRWkzekl_exh6Lf1_xev-ymwqUH1o1f/exec`) {
                fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(results) });
            }
        }

        const active = window.players.filter(p => p.active).map(p => p.name);
        if(active.length < 5) return alert("Besoin de 5 actifs");
        
        window.poolEnJeu = active.sort(() => 0.5 - Math.random()).slice(0, 5);
        window.poolEnJeu.forEach(n => {
            window.sessionStats[n] = (window.sessionStats[n] || 0) + 1;
        });
        window.playerStates = {};
        window.renderDisplay();
    };

    window.renderDisplay = () => {
        const div = document.getElementById('current-players'); div.innerHTML = '';
        const rows = [window.poolEnJeu.slice(0, 3), window.poolEnJeu.slice(3, 5)];
        rows.forEach(row => {
            const rowDiv = document.createElement('div'); rowDiv.className = 'player-row';
            row.forEach(n => {
                const s = window.playerStates[n] || 0;
                const b = document.createElement('div'); b.className = 'player-badge';
                if(s===1) { b.style.background='var(--yellow-4als)'; b.style.color='black'; }
                else if(s===2) { b.style.background='var(--orange-faf)'; b.style.color='white'; }
                else if(s===3) { b.style.background='var(--red-win)'; b.style.color='white'; }
                b.innerText = n; 
                b.onclick = () => {
                    window.playerStates[n] = ((window.playerStates[n] || 0) + 1) % 4;
                    window.renderDisplay();
                };
                rowDiv.appendChild(b);
            });
            div.appendChild(rowDiv);
        });
    };

    window.updateUI = () => {
        const cont = document.getElementById('list-p'); cont.innerHTML = '';
        window.players.forEach(p => {
            const d = document.createElement('div');
            d.style.padding = "10px"; d.style.border = "1px solid #ddd"; d.style.textAlign = "center";
            d.style.borderRadius = "15px"; d.innerText = p.name;
            cont.appendChild(d);
        });
    };

    window.openM = (id) => {
        document.getElementById(id).style.display = 'block';
        if(id === 'modal-sj') {
            const b = document.getElementById('list-stats-jour'); b.innerHTML = '';
            Object.keys(window.sessionStats).forEach(n => {
                b.innerHTML += `<tr><td>${n}</td><td>${window.sessionStats[n]}</td></tr>`;
            });
        }
    };
    window.closeM = (id) => document.getElementById(id).style.display = 'none';
    window.resetSession = () => { if(confirm("Reset session ?")) { window.sessionStats = {}; window.poolEnJeu = []; window.renderDisplay(); }};

    loadData();
</script>
</body>
</html>

