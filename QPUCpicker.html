<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>QPUC Picker - Historique</title>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --blue-main: #3498db;
            --white: #ffffff;
            --yellow-4als: #f1c40f;
            --orange-faf: #e67e22;
            --red-win: #c0392b;
            --btn-border: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--bg-dark); color: var(--white);
            font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden;
        }

        .main-container {
            width: 100%; max-width: 400px; height: 100vh; margin: 0 auto;
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 15px calc(45px + env(safe-area-inset-bottom)) 15px; 
            box-sizing: border-box; justify-content: space-between;
        }

        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; }
        .btn-top-reset {
            background: none; border: 1.5px solid var(--btn-border);
            color: white; border-radius: 30px; padding: 6px 15px;
            font-size: 0.75rem; cursor: pointer; text-transform: uppercase; font-weight: 600;
        }

        .btn-prochaine-partie {
            background-color: var(--blue-main); color: white;
            width: 100%; border-radius: 50px; padding: 15px 0;
            font-size: 1.4rem; border: none; cursor: pointer;
            text-transform: uppercase; margin-top: 10px; font-weight: 700;
        }

        .section-title { color: var(--blue-main); font-size: 0.8rem; margin-top: 20px; text-transform: uppercase; font-weight: 700; }

        #current-players { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 10px; flex: 1; width: 100%; }
        .player-row { display: flex; gap: 8px; justify-content: center; width: 100%; }

        .player-badge {
            background: white; color: black; border-radius: 25px;
            padding: 8px 15px; font-size: 1rem; min-width: 85px;
            text-align: center; cursor: pointer; font-weight: 600; text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .legend-area { width: 100%; text-align: center; margin-bottom: 5px; }
        .legend-flex { display: flex; justify-content: center; align-items: center; gap: 3px; font-size: 0.55rem; }
        .leg-box { padding: 3px 6px; border-radius: 10px; font-weight: 700; color: white; text-transform: uppercase; }

        .nav-buttons { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 5px; }
        .btn-nav {
            background: none; border: 1.5px solid var(--btn-border);
            color: white; border-radius: 30px; padding: 10px 0;
            font-size: 0.85rem; cursor: pointer; text-transform: uppercase; width: 100%; font-weight: 600;
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; z-index: 1000; padding: 10px; box-sizing: border-box;
        }
        .modal {
            background: white; border-radius: 25px; width: 95%; max-width: 380px;
            margin: 20px auto; position: relative; padding: 15px;
            color: black; display: flex; flex-direction: column; max-height: 80vh;
        }
        .modal-header {
            background: var(--blue-main); color: white; border-radius: 20px;
            padding: 10px; text-align: center; font-size: 1rem; text-transform: uppercase;
            margin-bottom: 10px; font-weight: 700;
        }
        .close-btn {
            position: absolute; top: -10px; right: -5px; width: 35px; height: 35px;
            background: #d00; border-radius: 50%; color: white; border: 2px solid white;
            font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .scroll-content { flex: 1; overflow-y: auto; padding-right: 5px; }
        #list-p { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .p-pill { 
            border: 1.5px solid #ddd; border-radius: 20px; padding: 8px 12px; 
            text-align: center; font-size: 0.85rem; cursor: pointer; color: #999; 
            font-weight: 600; display: flex; justify-content: space-between; align-items: center;
        }
        .p-pill.active { border-color: var(--blue-main); color: black; background: #f8f9fa; }

        .stats-table { width: 100%; border-collapse: collapse; }
        .stats-table th { font-size: 0.55rem; color: #888; text-align: center; padding-bottom: 5px; text-transform: uppercase; }
        .stats-table td { padding: 8px 4px; text-align: center; font-size: 0.85rem; border-bottom: 1px solid #f0f0f0; }
        .name-col { text-align: left; color: black; font-weight: 600; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="top-bar">
            <button class="btn-top-reset" onclick="window.confirmReset()">Nouvelle séance</button>
            <div id="status-sync" style="font-size: 0.5rem; opacity: 0.5;">Sync...</div>
        </div>
        
        <button class="btn-prochaine-partie" onclick="window.tirage()">Prochaine Partie</button>
        
        <div class="section-title">Partie en cours :</div>
        <div id="current-players"></div>

        <div class="legend-area">
            <div class="legend-flex">
                <div class="leg-box" style="background:white; color:black; border:1px solid #ddd">Sorti</div>
                <span style="color:#555">➔</span>
                <div class="leg-box" style="background:var(--yellow-4als)">4ALS</div>
                <span style="color:#555">➔</span>
                <div class="leg-box" style="background:var(--orange-faf)">FaF</div>
                <span style="color:#555">➔</span>
                <div class="leg-box" style="background:var(--red-win)">Gagnant</div>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="btn-nav" onclick="window.openM('modal-p')">Participants</button>
            <button class="btn-nav" onclick="window.openM('modal-sj')">Séance en cours</button>
            <button class="btn-nav" onclick="window.openM('modal-sp')">Statistiques</button>
        </div>
    </div>

    <div id="modal-p" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-p')">✕</div>
            <div class="modal-header">Édition Participants</div>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input type="text" id="add-input" placeholder="NOM..." style="flex:1; border-radius:15px; border:1px solid #ccc; padding:8px; text-transform: uppercase;">
                <button onclick="window.addPlayer()" style="background:var(--blue-main); color:white; border:none; width:35px; border-radius:50%; cursor:pointer;">+</button>
            </div>
            <div class="scroll-content"><div id="list-p"></div></div>
        </div>
    </div>

    <div id="modal-sj" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-sj')">✕</div>
            <div class="modal-header">Scores de la soirée</div>
            <div class="scroll-content">
                <table class="stats-table">
                    <thead><tr><th style="text-align:left">NOM</th><th>RÉEL</th><th>VIRTUEL</th></tr></thead>
                    <tbody id="list-stats-jour"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="modal-sp" class="overlay">
        <div class="modal">
            <div class="close-btn" onclick="window.closeM('modal-sp')">✕</div>
            <div class="modal-header">Global (Google Sheet)</div>
            <div class="scroll-content"><table class="stats-table" id="list-stats-perm"></table></div>
        </div>
    </div>

<script>
    const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQPwvi8vHPm7xDs4Yusv0xmZq7ek9Z2ZQJ8DvcWITvkoiwanW5pGwwqJzESzeBNW0LEa_WibdeA3b0Z/pub?output=csv`;
    const WEB_APP_URL = "TON_URL_WEB_APP_GOOGLE_SCRIPT"; // <--- REMPLACE PAR TON LIEN SCRIPT

    const INITIAL_LIST = ["ANTOINE", "CYRILLE", "DAMIEN", "DANIÈLE", "ELIOTT", "ERIC", "GEOFFREY", "HENRICK", "LOUIS", "LYSIANE", "MADELEINE", "MICHÈLE", "PATRICE", "PATRICIA C", "PATRICIA L", "PHILIPPE L", "PHILIPPE M", "PHILIPPE O", "RENÉ", "ROLANDE", "SÉBASTIEN"];

    window.players = INITIAL_LIST.map(n => ({ name: n, active: true }));
    window.sessionStats = {}; 
    window.sessionBoost = {}; 
    window.lastPool = [];
    window.poolEnJeu = [];
    window.playerStates = {};
    window.sheetData = [];

    async function loadData() {
        try {
            const res = await fetch(CSV_URL + "&cb=" + Date.now());
            const data = await res.text();
            window.sheetData = data.split('\n').slice(1).map(row => row.split(','));
            document.getElementById('status-sync').innerText = "Sync OK";
        } catch(e) { document.getElementById('status-sync').innerText = "Erreur Sync"; }
        window.updateUI();
    }

    // Fonction pour envoyer les résultats au Sheet
    async function sendResultsToSheet() {
        if(window.poolEnJeu.length === 5) {
            const results = window.poolEnJeu.map(n => ({ 
                name: n, 
                status: window.playerStates[n] || 0 
            }));
            try {
                await fetch(WEB_APP_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(results) 
                });
            } catch(e) { console.error("Erreur d'envoi", e); }
        }
    }

    window.tirage = async () => {
        // Envoi du tirage précédent avant d'en générer un nouveau
        await sendResultsToSheet();
        window.lastPool = [...window.poolEnJeu];

        const actifs = window.players.filter(p => p.active).map(p => p.name);
        if(actifs.length < 5) return alert("Besoin de 5 actifs");

        const regScores = actifs.filter(n => (window.sessionBoost[n] || 0) >= 0).map(n => window.sessionStats[n] || 0);
        const minRef = regScores.length > 0 ? Math.min(...regScores) : 0;

        const candidats = actifs.map(name => {
            let reel = window.sessionStats[name] || 0;
            let boost = window.sessionBoost[name] || 0;
            if(boost === -1 && reel > 0) {
                window.sessionBoost[name] = minRef - reel;
                boost = window.sessionBoost[name];
            }
            let scoreBase = reel + boost;
            let penalite = window.lastPool.includes(name) ? 100 : 0;
            return { name, scoreFinal: scoreBase + penalite + (Math.random() * 0.4) };
        });

        candidats.sort((a, b) => a.scoreFinal - b.scoreFinal);
        window.poolEnJeu = candidats.slice(0, 5).map(p => p.name);
        window.playerStates = {};
        window.poolEnJeu.forEach(n => { window.sessionStats[n] = (window.sessionStats[n] || 0) + 1; });
        window.renderDisplay();
    };

    window.confirmReset = async () => {
        if(confirm("Démarrer une nouvelle séance ? (Le dernier tirage sera sauvegardé)")) {
            await sendResultsToSheet(); // Sauvegarde du dernier tour avant reset
            window.sessionStats = {}; 
            window.sessionBoost = {}; 
            window.lastPool = []; 
            window.poolEnJeu = []; 
            window.renderDisplay();
        }
    };

    window.renderDisplay = () => {
        const div = document.getElementById('current-players'); div.innerHTML = '';
        if(window.poolEnJeu.length === 0) return;
        const rows = [window.poolEnJeu.slice(0, 3), window.poolEnJeu.slice(3, 5)];
        rows.forEach(row => {
            const rDiv = document.createElement('div'); rDiv.className = 'player-row';
            row.forEach(n => {
                const b = document.createElement('div'); b.className = 'player-badge';
                const s = window.playerStates[n] || 0;
                if(s===1) b.style.background = 'var(--yellow-4als)';
                if(s===2) b.style.background = 'var(--orange-faf)';
                if(s===3) b.style.background = 'var(--red-win)';
                if(s>0) b.style.color = (s===1)?'black':'white';
                b.innerText = n;
                b.onclick = () => { window.playerStates[n]=((window.playerStates[n]||0)+1)%4; window.renderDisplay(); };
                rDiv.appendChild(b);
            });
            div.appendChild(rDiv);
        });
    };

    window.addPlayer = () => {
        const n = document.getElementById('add-input').value.trim().toUpperCase();
        if(n) {
            if(!window.players.find(p => p.name === n)) window.players.push({ name: n, active: true });
            window.sessionStats[n] = 0; window.sessionBoost[n] = -1;
            document.getElementById('add-input').value = ''; window.updateUI();
        }
    };

    window.updateUI = () => {
        const cont = document.getElementById('list-p'); cont.innerHTML = '';
        window.players.sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
            const d = document.createElement('div'); d.className = `p-pill ${p.active?'active':''}`;
            d.innerText = p.name; d.onclick = () => { p.active = !p.active; window.updateUI(); };
            cont.appendChild(d);
        });
    };

    window.openM = (id) => {
        document.getElementById(id).style.display = 'block';
        if(id === 'modal-sj') {
            const b = document.getElementById('list-stats-jour'); b.innerHTML = '';
            window.players.filter(p=>p.active).forEach(p => {
                let r = window.sessionStats[p.name]||0; let v = r + (window.sessionBoost[p.name]||0);
                b.innerHTML += `<tr><td class="name-col">${p.name}</td><td>${r}</td><td>${v.toFixed(1)}</td></tr>`;
            });
        }
        if(id === 'modal-sp') {
            const t = document.getElementById('list-stats-perm');
            t.innerHTML = '<thead><tr><th>NOM</th><th>PJ</th><th>%4A</th><th>%FAF</th><th>W</th></tr></thead><tbody>';
            window.sheetData.forEach(c => { if(c[0]) t.innerHTML += `<tr><td class="name-col">${c[0]}</td><td>${c[1]}</td><td>${c[1]?Math.round(c[2]/c[1]*100):0}%</td><td>${c[1]?Math.round(c[3]/c[1]*100):0}%</td><td>${c[4]||0}</td></tr>`; });
            t.innerHTML += '</tbody>';
        }
    };

    window.closeM = (id) => document.getElementById(id).style.display = 'none';
    loadData();
</script>
</body>
</html>
