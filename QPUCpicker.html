<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Random Picker - Compact</title>
    <style>
        :root {
            --primary: #2ecc71; --secondary: #3498db; --danger: #e74c3c;
            --bg: #1a1a1a; --card: #2d2d2d; --text: #ffffff; --mix: #888888;
        }
        body {
            font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg);
            color: var(--text); margin: 0; display: flex; flex-direction: column;
            height: 100vh; overflow: hidden; align-items: center;
        }
        
        /* Zone d'affichage réduite pour remonter le bouton vert */
        #display-area { 
            flex: 0 1 auto; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            width: 100%; 
            padding: 10px 20px; 
            margin-top: 10px;
        }

        #count-info { background: rgba(52, 152, 219, 0.2); padding: 5px 15px; border-radius: 15px; font-size: 0.8rem; color: var(--secondary); margin-bottom: 5px; font-weight: bold; }
        
        #current-players { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 100px; }
        
        .player-badge { background: var(--secondary); padding: 8px 16px; border-radius: 30px; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.5); animation: popIn 0.4s; }
        
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Positionnement du bouton vert */
        #control-area { padding: 10px; }
        .roll-btn { 
            width: 120px; height: 120px; border-radius: 50%; border: none; 
            background: var(--primary); color: white; font-weight: bold; 
            font-size: 0.9rem; text-transform: uppercase; 
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.3); cursor: pointer; 
        }

        /* Pied de page remonté */
        #footer { padding: 10px; width: 100%; box-sizing: border-box; display: flex; gap: 10px; margin-bottom: 5px; }
        .btn-nav { flex: 1; padding: 12px; border-radius: 12px; border: none; background: var(--card); color: white; font-weight: bold; font-size: 0.8rem; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 1000; }
        .modal-content { position: absolute; bottom: 0; width: 100%; height: 85vh; background: #fff; color: #333; border-radius: 20px 20px 0 0; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
        
        /* 2 Colonnes pour les participants */
        #list-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            overflow-y: auto; 
            flex: 1; 
            padding-top: 10px;
        }
        
        #stats-container { overflow-y: auto; flex: 1; }

        .item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; background: #f9f9f9; border-radius: 8px; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        .name { flex: 1; margin: 0 8px; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .del-btn { color: var(--danger); border: none; background: none; font-size: 1.4rem; padding: 0 5px; }

        .stat-header { display: flex; font-weight: bold; font-size: 0.75rem; color: #666; padding: 8px 0; border-bottom: 2px solid #eee; }
        .stat-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .col-name { flex: 2; font-weight: bold; font-size: 0.9rem; }
        .col-games { flex: 1; text-align: center; }
        .col-mix { flex: 1; text-align: center; color: var(--mix); font-weight: bold; }
        
        .total-parties { background: var(--bg); color: white; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: center; font-size: 0.9rem; }
        .close-btn { align-self: flex-end; font-size: 22px; border: none; background: none; padding: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="display-area">
        <div id="count-info">Actifs : 0</div>
        <div style="color:var(--secondary); margin-bottom:10px; letter-spacing:1px; font-size:0.7rem; font-weight: bold;">PLATEAU ACTUEL</div>
        <div id="current-players"><p style="opacity: 0.4; font-size: 0.8rem;">Prêt à jouer</p></div>
    </div>

    <div id="control-area">
        <button class="roll-btn" onclick="executeRoll()">SUIVANT</button>
    </div>

    <div id="footer">
        <button class="btn-nav" onclick="toggleModal('modal-participants', true)">PARTICIPANTS</button>
        <button class="btn-nav" onclick="toggleModal('modal-stats', true)">STATS</button>
    </div>

    <div id="modal-participants" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleModal('modal-participants', false)">✕</button>
            <div style="display:flex; gap:8px; margin-bottom: 10px;">
                <input type="text" id="new-name" placeholder="Nom..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px; font-size: 16px;">
                <button onclick="addNewName()" style="background:var(--primary); color:white; border:none; width:45px; border-radius:8px; font-size:20px;">+</button>
            </div>
            <div id="list-container"></div>
        </div>
    </div>

    <div id="modal-stats" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleModal('modal-stats', false)">✕</button>
            <div class="total-parties">Parties : <span id="total-rounds-count">0</span></div>
            <div class="stat-header"><span style="flex:2">NOM</span><span style="flex:1; text-align:center">JEUX</span><span style="flex:1; text-align:center">MIX</span></div>
            <div id="stats-container"></div>
        </div>
    </div>

    <script>
        const initialNames = ["Eric", "Danièle", "René", "Louis", "Madeleine", "Antoine", "Patrice", "Eliott", "Henrick", "Yann", "Philippe O", "Philippe M", "Damien", "Patricia L", "Valérie", "Geoffrey", "Michèle", "Patricia C", "Sébastien", "Lysiane", "Rolande", "Jean-Pierre", "Jean-Marie"];
        const excluded = ["Philippe M", "Michèle", "Rolande", "Jean-Pierre", "Jean-Marie"];

        let participants = initialNames.map(n => ({ id: Math.random().toString(36).substr(2, 9), name: n, active: !excluded.includes(n) }));
        let stats = {};
        let historyPools = [], poolEnJeu = [], poolIndispo = [], totalRounds = 0;

        initialNames.forEach(n => stats[n] = { games: 0, mixScore: 0, encounters: {} });

        function getMinScoreExcluding(excludeName) {
            const others = participants.filter(p => p.active && p.name !== excludeName);
            if (others.length === 0) return 0;
            return Math.min(...others.map(p => stats[p.name].games));
        }

        function updateLists() {
            participants.sort((a, b) => a.name.localeCompare(b.name, 'fr'));
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            let activeCount = 0;
            participants.forEach(p => {
                if (p.active) activeCount++;
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `<input type="checkbox" ${p.active ? 'checked' : ''} onchange="toggleP('${p.id}')"><span class="name" style="${p.active ? 'font-weight:bold;' : 'color:#999;'}">${p.name}</span><button class="del-btn" onclick="deleteP('${p.id}')">−</button>`;
                container.appendChild(div);
            });
            document.getElementById('count-info').innerText = `Actifs : ${activeCount}`;
        }

        function toggleP(id) {
            const p = participants.find(x => x.id === id);
            if(p) {
                p.active = !p.active;
                if (p.active) stats[p.name].games = getMinScoreExcluding(p.name);
                updateLists();
            }
        }

        function deleteP(id) {
            const p = participants.find(x => x.id === id);
            if(p) { delete stats[p.name]; participants = participants.filter(x => x.id !== id); updateLists(); }
        }

        function addNewName() {
            const val = document.getElementById('new-name').value.trim();
            if(val) {
                const min = getMinScoreExcluding(""); 
                participants.push({ id: Date.now().toString(), name: val, active: true });
                stats[val] = { games: min, mixScore: 0, encounters: {} };
                document.getElementById('new-name').value = '';
                updateLists();
            }
        }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
            if (id === 'modal-stats' && show) renderStats();
        }

        function executeRoll() {
            const activeNames = participants.filter(p => p.active).map(p => p.name);
            let candidates = activeNames.filter(name => !poolEnJeu.includes(name) && !poolIndispo.includes(name));
            if (candidates.length < 5) candidates.push(...poolIndispo.filter(name => activeNames.includes(name)));
            if (candidates.length === 0) return;

            let minGames = Math.min(...candidates.map(name => stats[name].games));
            let priority = candidates.filter(name => stats[name].games === minGames);
            let secondary = candidates.filter(name => stats[name].games > minGames);

            priority.sort(() => Math.random() - 0.5);
            secondary.sort(() => Math.random() - 0.5);

            let selection = priority.splice(0, 5);
            if (selection.length < 5) selection.push(...secondary.splice(0, 5 - selection.length));

            poolIndispo = [...poolEnJeu]; poolEnJeu = [...selection];

            if(selection.length > 0) {
                totalRounds++;
                const signature = [...selection].sort().join('|');
                if (historyPools.indexOf(signature) !== -1) alert(`⚠️ Doublon Round ${historyPools.indexOf(signature) + 1}`);
                historyPools.push(signature);

                selection.forEach(player => {
                    const pStat = stats[player];
                    const others = selection.filter(p => p !== player);
                    others.forEach(partner => {
                        const timesMet = pStat.encounters[partner] || 0;
                        if (timesMet > 0 && pStat.games > 0) pStat.mixScore -= timesMet;
                        pStat.encounters[partner] = timesMet + 1;
                    });
                    pStat.games += 1;
                });
                renderDisplay();
            }
        }

        function renderDisplay() {
            const container = document.getElementById('current-players');
            container.innerHTML = '';
            poolEnJeu.forEach(name => {
                const d = document.createElement('div');
                d.className = 'player-badge'; d.innerText = name;
                container.appendChild(d);
            });
        }

        function renderStats() {
            document.getElementById('total-rounds-count').innerText = totalRounds;
            const container = document.getElementById('stats-container');
            container.innerHTML = '';
            const activeNamesSet = new Set(participants.filter(p => p.active).map(p => p.name));
            Object.keys(stats).filter(name => activeNamesSet.has(name)).sort((a,b) => a.localeCompare(b,'fr')).forEach(name => {
                const p = stats[name];
                const div = document.createElement('div');
                div.className = 'stat-row';
                div.innerHTML = `<span class="col-name">${name}</span><span class="col-games">${p.games}</span><span class="col-mix">${p.mixScore}</span>`;
                container.appendChild(div);
            });
        }
        updateLists();
    </script>
</body>
</html>
